M291 R"Test Servo?" P" " S3

; Rotate holder to 0 degree
M98 P"0:/macros/System/Calibration/Z Probe/Rotate holder to 0 degree"
G4 S1
; Rotate holder to a set degree
M98 P"0:/macros/System/Calibration/Z Probe/Rotate holder to a set degree"
G4 S1
; Rotate holder back to 0 degree
M98 P"0:/macros/System/Calibration/Z Probe/Rotate holder to 0 degree"


M291 R"Mode build plate close to the nozzle" P"Move the build plate close to the nozzle" Z1 S3

; Enable probe
M98 P"0:/macros/System/Calibration/Testing/Enable Probe"

var max_iter = 200
var iter = 0



; 1 - T0 -> Build Plate ============================================================================
; check if z-probe value is 1000
if sensors.probes[0].value[0] == 1000
    M291 R"Touch the nozzle" P"Touch Left Nozzle to the Bed, Z - Probe value should change to 0" S1 T60
else
    M106 P6 S0
    M42 P2 S0 ; set red LED
    abort "Error: Z-Probe value is not 1000"

; wait for z-probe value to change to 0
while sensors.probes[0].value[0] != 0
    G4 P100
    set var.iter = var.iter + 1

if var.iter <= var.max_iter
    M292
    M106 P6 S0
    M42 P2 S1 ; set green LED
else
    M106 P6 S0
    M42 P1 S1 ; set red LED
    abort "Error: Z-Probe value did not change to 0"


G4 S2
M98 P"0:/sys/led/statusoff.g"
M98 P"0:/sys/led/restorewhite.g"



; 2 - T1 -> Build Plate ============================================================================
; check if z-probe value is 1000
if sensors.probes[0].value[0] == 1000
    M291 R"Touch the nozzle" P"Touch Right Nozzle to the Bed, Z - Probe value should change to 0" S1 T60
else
    M106 P6 S0
    M42 P2 S0 ; set red LED
    abort "Error: Z-Probe value is not 1000"

; wait for z-probe value to change to 0
while sensors.probes[0].value[0] != 0
    G4 P100
    set var.iter = var.iter + 1

if var.iter <= var.max_iter
    M292
    M106 P6 S0
    M42 P2 S1 ; set green LED
else
    M106 P6 S0
    M42 P1 S1 ; set red LED
    abort "Error: Z-Probe value did not change to 0"


G4 S2
M98 P"0:/sys/led/statusoff.g"
M98 P"0:/sys/led/restorewhite.g"







; 3 - Attach the Z-Probe to the holder ============================================================================
; check if z-probe value is 1000
if sensors.probes[0].value[0] == 1000
    M291 R"Attach the Z-Probe to the holder" P"Attach the Z-Probe to the holder, Z - Probe value should change to 0" S1 T60
else
    M106 P6 S0
    M42 P2 S0 ; set red LED
    abort "Error: Z-Probe value is not 1000"

; wait for z-probe value to change to 0
while sensors.probes[0].value[0] != 0
    G4 P100
    set var.iter = var.iter + 1

if var.iter <= var.max_iter
    M292
    M106 P6 S0
    M42 P2 S1 ; set green LED
else
    M106 P6 S0
    M42 P1 S1 ; set red LED
    abort "Error: Probe was not recognized"


G4 S2
M98 P"0:/sys/led/statusoff.g"
M98 P"0:/sys/led/restorewhite.g"



; 4 - Click the Z-Probe ============================================================================
; check if z-probe value is 0
if sensors.probes[0].value[0] == 0
    M291 R"Click the Z-Probe" P"Click the Z-Probe, Z - Probe value should change to 1000" S1 T60
else
    M106 P6 S0
    M42 P2 S0 ; set red LED
    abort "Error: S4 Probe was not attached"

; wait for z-probe value to change to 1000
while sensors.probes[0].value[0] != 1000
    G4 P100
    set var.iter = var.iter + 1

if var.iter <= var.max_iter
    M292
    M106 P6 S0
    M42 P2 S1 ; set green LED
else
    M106 P6 S0
    M42 P1 S1 ; set red LED
    abort "Error: S4 Probe might be damaged"


G4 S2
M98 P"0:/sys/led/statusoff.g"
M98 P"0:/sys/led/restorewhite.g"


; Disable probe
M291 R"Disable Probe" P"Do you want to disable the probe?" S3
M98 P"0:/macros/System/Calibration/Testing/Disable Probe"