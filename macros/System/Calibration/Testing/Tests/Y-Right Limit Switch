; Display a message to start the right Y-axis endstop test
M291 P"Check the right Y-axis endstop. Within 60 seconds, press the right Y-axis endstop. Press OK to start." S3 T0

; Initialize the timer for right endstop test
var startTime = state.time  ; Reset the timer
var duration = 60  ; Set the timer duration to 60 seconds
var endstopTriggered = false  ; Reset the endstop state

; Configure the right Y-axis endstop
M574 Y1 S1 P"io2.in"  ; Configure the Y endstop on io2.in

; Main loop to check the right Y-axis endstop for 60 seconds
while state.time < {var.startTime + var.duration}
    if sensors.endstops[1].triggered
        set var.endstopTriggered = true  ; Set the state to true if the endstop is triggered
        break  ; Exit the loop if the endstop is triggered
    G4 P100  ; Wait for 100 ms between checks

; Process the test results for the right endstop
if var.endstopTriggered
    M291 P"The right Y-axis endstop is correctly connected." S2 T0  ; Display a message with a single OK button
else
    M291 P"The right Y-axis endstop was not pressed or is not working / incorrectly connected. Retry the test?" R"Right Endstop Test Failed" S4 T0 K{"OK", "Cancel"}
    
    if input == 0
        M98 P"0:/macros/System/Calibration/Testing/Tests/Y-Right Limit Switch"  ; Restart the right endstop test
    elif input == 1
        abort "Test canceled by user."  ; Terminate the script


; Reconfigure the Y-axis endstops to use both left and right
M574 Y1 S1 P"io1.in+io2.in"  ; Configure endstops for both sides of the Y axis